%% generate images using random walk method
%% generate images with folder every plots respectively
%% for imgs combined muti-spectrum ,datatype :uint8 & float
% set the expect size of training set
% By Yang Qi 2018.3.1

clc
clear
close all
addpath('functions')

%++++++++++++++++++++++++++++++++++++++++++
% set hyperparameter
rng(0)
datasetsize = 240  % how many plots do you have
discardsample = [];
subimagecount = 0;
inputrow = 156;  % size of input image
inputcol = 156;  % size of input image
tolerance_rate = 0  % how many nodata pixels allowed when cropping a image
tolerance = floor(tolerance_rate*inputrow*inputcol);
subdir='./';           % output path
datapath = 'D:\CNNN\X\'               % input path
datatype = 1;       % 3:single,,,1:uint8
uplim_step = 100;  % the maximum steps for random cropping
downlim_step = 10;   
init_randomwalk_step = 25;           % initial number of random cropping
iteration = 2   ;        % iteration number for adaptive cropping 
USE_jpg = 1 ;           %褰撲负1鏃朵繚瀛樻垚jpg鏂囦欢,0鏃朵负tif
%++++++++++++++++++++++++++++++++++++++++++

[yield_class, statics_yield] = yield_distribution();    % function for yield statistics
class_num = max(yield_class) + 1;
%%
%% Random Walk
walkstep = init_randomwalk_step * ones(datasetsize,1);
wb=waitbar(0);
for num = 1:datasetsize
    tem=imread([datapath,num2str(num),'.tif']);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
    if datatype == 1
        im=uint8(tem);
    end
    if datatype == 3
        im=single(tem);
        loc= find(im<0);
        00.  
        im(loc)=0;
    end
    
    % imshow(im);
    [~,count(num,1)] = random_walk(im , walkstep(num), inputrow, inputcol, tolerance);     % my function
    waitbar((num/datasetsize),wb,[num2str((num/datasetsize)*100,3),'%',' finished']);
end
clearvars im tem


%% statics
% output the distribution of crop images
total_imgs = sum(count)
for i=1:length(statics_yield)
    local_tem = find(yield_class == i-1);
    cropimgs_class(i,1) = sum(count(local_tem));
end
statics2=tabulate(cropimgs_class);

figure   % show the distribution of cropimages
bar(1:length(statics_yield), cropimgs_class, 1);
meancrops = total_imgs/class_num;
%% trainstep

% adjust the value of walkstep
% train walkstep
walkstep_track = walkstep;
learnrate = 0.01./(cropimgs_class./max(cropimgs_class));
for j = 1:iteration
    wb=waitbar(0);
    residual = cropimgs_class - repmat(meancrops,class_num,1);
    
    for i = 1:length(yield_class)
        delta_step(i,1) = residual(yield_class(i) + 1);
        walkstep(i,1) = walkstep(i,1) - floor(learnrate(yield_class(i)+1) * delta_step(i,1));
        if walkstep(i,1) > uplim_step
            walkstep(i,1)=uplim_step;
        end
        if walkstep(i,1)<downlim_step
            walkstep(i,1) =downlim_step;
        end
    end
    walkstep_track = [walkstep_track,walkstep];
    for num = 1:datasetsize
        tem=imread([datapath,num2str(num),'.tif']);
        if datatype == 1
            im=uint8(tem);
        end
        if datatype == 3
            im=single(tem);
            loc= find(im<0);
            im(loc)=0;
        end;
        clearvars tem
        % imshow(im);
        [walkmat{num,1},count(num,1)] = random_walk(im , walkstep(num), inputrow, inputcol, tolerance);     % my function
        if count(num,1)==0
            [walkmat{num,1},count(num,1)] = random_walk(im ,...       % 濡傛灉鏌恗ask 娌℃湁crop鍒板浘鍍忥紝鍒檞alkstep*2
                walkstep(num)*3, inputrow, inputcol, tolerance); 
        elseif (count(num,1) > 0 && count(num,1) < 3)
                        [walkmat{num,1},count(num,1)] = random_walk(im ,...       % 濡傛灉鏌恗ask 娌℃湁crop鍒板浘鍍忥紝鍒檞alkstep*2
                floor(walkstep(num)*2), inputrow, inputcol, tolerance); 
        end
        waitbar((num/datasetsize),wb,[num2str((num/datasetsize)*100,3),'%',' finished']);
    end
    clearvars im
    total_imgs = sum(count)
    for i=1:length(statics_yield)
        local_tem = find(yield_class == i-1);
        cropimgs_class(i,1) = sum(count(local_tem));
    end
    statics2=tabulate(cropimgs_class);
    
    figure   % show the distribution of cropimages
    bar(1:length(statics_yield), cropimgs_class, 1);
end

%%
%% save image
if datatype == 1
    bit = 8;       %32:single,,,,8:uint8
elseif datatype == 3
    bit = 32;
end
wb=waitbar(0);
if ~exist(subdir,'dir')
    mkdir(subdir)         % 閿熸枻鎷烽敓鏂ゆ嫹閿熸枻鎷烽敓鑺傦綇鎷烽敓鑺傜鎷峰墠鐩綍閿熷彨璇ф嫹閿熸枻鎷蜂竴閿熸枻鎷风洰褰?
end
for num = 1:datasetsize
    if ~isempty(walkmat{num})
        
        for i = 1:length(walkmat{num})
            if USE_jpg == 1
                path = ['./',subdir,'/im',num2str(num),'_',num2str(i),'.jpg'];
                imwrite(walkmat{num}{i},path);                     %鍥犱负jpg 涓烘湁鎹熷帇缂╋紝鎵?浠ヤ細鏀瑰彉img鐨勫?硷紝姝ゅ涓峜heck
                
            elseif USE_jpg == 0
                check(subimagecount + 1) = floatTiffwrite(walkmat{num}{i},['./',subdir,'/im',num2str(num),'_',num2str(i),'.tif'],bit,datatype);
            else
                disp('Setting ERR!')
            end
            subimagecount = subimagecount +1;
        end
        
    else
        
        discardsample = [discardsample;num];
    end
    waitbar((num/datasetsize),wb,[num2str((num/datasetsize)*100,3),'%',' finished']);
end

if USE_jpg == 1
    disp ('.jpg write job done ')
else
    if min(check)==1
        status = 'pass';
    else
        status = 'failed'
    end
    disp (['check ',status])
end
